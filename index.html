<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PROJECT DOPPELGANGER</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@700&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #0A0A0A;
            font-family: 'IBM Plex Mono', monospace;
            color: #E0E0E0;
        }
        .font-display {
            font-family: 'Syne', sans-serif;
            letter-spacing: 0.05em;
        }
        #file-upload { display: none; }
        #drop-zone {
            border-color: #444;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        #drop-zone.drag-over {
            background-color: #1a1aff;
            border-color: #00ffff;
        }
        .btn {
            background-color: transparent;
            border: 1px solid #E0E0E0;
            padding: 0.75rem 1.5rem;
            font-weight: 500;
            color: #E0E0E0;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }
        .btn:hover { background-color: #E0E0E0; color: #0A0A0A; }
        .btn-primary { border-color: #00ffff; color: #00ffff; }
        .btn-primary:hover { background-color: #00ffff; color: #0A0A0A; box-shadow: 0 0 15px rgba(0, 255, 255, 0.5); }
        .temp-btn {
            border: 1px solid #555;
            color: #888;
            transition: all 0.2s ease-in-out;
        }
        .temp-btn.active { color: #FFFFFF; border-color: #FFFFFF; background-color: #222; }
        .temp-btn.hot:hover, .temp-btn.hot.active { border-color: #FF8A00; color: #FF8A00; }
        .temp-btn.warm:hover, .temp-btn.warm.active { border-color: #FFC900; color: #FFC900; }
        .temp-btn.cold:hover, .temp-btn.cold.active { border-color: #00A3FF; color: #00A3FF; }
        .temp-btn.frozen:hover, .temp-btn.frozen.active { border-color: #00E0FF; color: #00E0FF; }
        
        #transition-canvas { transition: opacity 0.4s ease-in-out; }

        /* AI Code Loader Styles */
        #loader-overlay {
            mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
            -webkit-mask-image: linear-gradient(to bottom, transparent 0%, black 15%, black 85%, transparent 100%);
        }
        .code-column {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            white-space: nowrap;
            font-size: 1rem;
            line-height: 1.5;
            color: rgba(255, 255, 255, 0.8);
            text-shadow: 0 0 5px rgba(255, 255, 255, 0.5);
            animation: scroll-up 3s linear infinite;
        }
        @keyframes scroll-up {
            from { transform: translateY(0%); }
            to { transform: translateY(-50%); }
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-3xl text-center">
        <!-- Header -->
        <header class="mb-12">
            <h1 class="font-display text-4xl md:text-5xl font-bold text-white">PROJECT DOPPELGANGER</h1>
            <p class="mt-2 text-sm text-gray-400">REPLICATE THE LOOK</p>
        </header>

        <!-- Canvases (hidden) -->
        <canvas id="original-canvas" class="hidden"></canvas>
        <canvas id="curves-canvas" class="hidden"></canvas>
        <canvas id="processed-canvas" class="hidden"></canvas>

        <!-- Main container for dynamic content -->
        <main class="relative min-h-[200px]">
            <!-- Drop Zone -->
            <div id="drop-zone" class="border-2 border-dashed rounded-none p-10 cursor-pointer">
                <div id="upload-prompt">
                    <p class="font-medium text-lg">DRAG & DROP IMAGE</p>
                    <p class="text-xs text-gray-500 mt-1">OR CLICK TO SELECT FILE</p>
                    <input type="file" id="file-upload" accept="image/png, image/jpeg, image/webp">
                </div>
            </div>

            <!-- Loading Overlay -->
            <div id="loader-overlay" class="absolute inset-0 bg-black flex justify-around hidden overflow-hidden">
                <!-- Code columns will be generated here -->
            </div>

            <!-- Main Content Area (hidden until upload) -->
            <div id="content-area" class="hidden">
                 <!-- Image Preview Area with Transition Canvas -->
                <div id="image-preview-container" class="mt-8 relative">
                    <img id="image-preview" src="#" alt="Processed image" class="w-full h-auto border border-gray-700 bg-black">
                    <canvas id="transition-canvas" class="absolute top-0 left-0 w-full h-full pointer-events-none"></canvas>
                </div>

                <!-- Temperature Controls -->
                <div id="temp-controls" class="mt-8">
                    <p class="text-sm text-gray-400 mb-4">TEMPERATURE</p>
                    <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                        <button class="temp-btn hot" data-temp="hot">HOT</button>
                        <button class="temp-btn warm" data-temp="warm">WARM</button>
                        <button class="temp-btn cold" data-temp="cold">COLD</button>
                        <button class="temp-btn frozen" data-temp="frozen">FROZEN</button>
                    </div>
                </div>
            
                <!-- Action Buttons -->
                <div id="action-buttons" class="mt-8">
                    <button id="download-btn" class="btn btn-primary w-full sm:w-auto">DOWNLOAD REPLICA</button>
                    <button id="reset-btn" class="btn mt-4 sm:mt-0 sm:ml-4 w-full sm:w-auto">NEW SUBJECT</button>
                </div>
            </div>
        </main>

        <footer class="mt-16">
            <p class="text-xs text-gray-600">A digital art experiment. All processing is done client-side.</p>
        </footer>
    </div>

    <script>
        // DOM element references
        const dropZone = document.getElementById('drop-zone');
        const loaderOverlay = document.getElementById('loader-overlay');
        const fileUpload = document.getElementById('file-upload');
        const contentArea = document.getElementById('content-area');
        const imagePreview = document.getElementById('image-preview');
        const tempControls = document.getElementById('temp-controls');
        const downloadBtn = document.getElementById('download-btn');
        const resetBtn = document.getElementById('reset-btn');
        
        // Canvas elements
        const originalCanvas = document.getElementById('original-canvas');
        const curvesCanvas = document.getElementById('curves-canvas');
        const processedCanvas = document.getElementById('processed-canvas');
        const transitionCanvas = document.getElementById('transition-canvas');
        const originalCtx = originalCanvas.getContext('2d');
        const curvesCtx = curvesCanvas.getContext('2d');
        const processedCtx = processedCanvas.getContext('2d');
        const transitionCtx = transitionCanvas.getContext('2d');

        let currentTemp = 'warm';
        let isTransitioning = false;
        let loaderInterval = null;

        // --- Event Listeners ---
        dropZone.addEventListener('click', () => fileUpload.click());
        fileUpload.addEventListener('change', (e) => { const file = e.target.files[0]; if (file) handleFile(file); });
        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('drag-over'); });
        dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('drag-over'); });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault(); e.stopPropagation();
            dropZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file) handleFile(file);
        });
        downloadBtn.addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = `DOPPELGANGER_${currentTemp.toUpperCase()}.png`;
            link.href = processedCanvas.toDataURL('image/png');
            link.click();
        });
        resetBtn.addEventListener('click', () => {
            fileUpload.value = '';
            contentArea.classList.add('hidden');
            dropZone.classList.remove('hidden');
        });
        tempControls.addEventListener('click', (e) => {
            if (e.target.matches('.temp-btn') && !isTransitioning) {
                const selectedTemp = e.target.dataset.temp;
                if (selectedTemp !== currentTemp) {
                    initiateTemperatureChange(selectedTemp);
                }
            }
        });

        // --- AI Code Loader Animation Logic ---
        const codeChars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+-=[]{}|;:,.<>?';
        function generateCodeLine() {
            let line = '';
            const length = Math.floor(Math.random() * 10) + 5;
            for (let i = 0; i < length; i++) {
                line += codeChars.charAt(Math.floor(Math.random() * codeChars.length));
            }
            const prefixes = ['const ', 'let ', 'var ', 'function ', '() => ', '0x', 'if (', 'return '];
            return Math.random() > 0.7 ? prefixes[Math.floor(Math.random() * prefixes.length)] + line : line;
        }

        function startLoaderAnimation() {
            loaderOverlay.innerHTML = ''; // Clear previous
            const numColumns = Math.floor(window.innerWidth / 50);
            for (let i = 0; i < numColumns; i++) {
                const column = document.createElement('div');
                column.className = 'code-column';
                // Populate with initial content
                for(let j = 0; j < 30; j++) {
                    column.textContent += generateCodeLine() + '\n';
                }
                loaderOverlay.appendChild(column);
            }

            loaderInterval = setInterval(() => {
                document.querySelectorAll('.code-column').forEach(col => {
                    col.textContent = generateCodeLine() + '\n' + col.textContent;
                     // Trim to prevent performance issues
                    if (col.textContent.length > 2000) {
                        col.textContent = col.textContent.substring(0, 2000);
                    }
                });
            }, 50);
        }

        function stopLoaderAnimation() {
            clearInterval(loaderInterval);
            loaderInterval = null;
        }

        // --- Core Logic ---
        function handleFile(file) {
            dropZone.classList.add('hidden');
            loaderOverlay.classList.remove('hidden');
            contentArea.classList.add('hidden');
            startLoaderAnimation();

            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const minLoaderTime = new Promise(resolve => setTimeout(resolve, 1500));
                    const processing = new Promise(resolve => {
                        processImage(img);
                        resolve();
                    });

                    Promise.all([processing, minLoaderTime]).then(() => {
                        stopLoaderAnimation();
                        loaderOverlay.classList.add('hidden');
                        contentArea.classList.remove('hidden');
                    });
                };
                img.onerror = () => {
                    alert("FILE READ ERROR. PLEASE TRY AGAIN.");
                    stopLoaderAnimation();
                    loaderOverlay.classList.add('hidden');
                    dropZone.classList.remove('hidden');
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        function processImage(img) {
            const { width, height } = img;
            [originalCanvas, curvesCanvas, processedCanvas, transitionCanvas].forEach(canvas => {
                canvas.width = width;
                canvas.height = height;
            });
            originalCtx.drawImage(img, 0, 0);
            const curveImageData = originalCtx.getImageData(0, 0, width, height);
            applyChannelCurves(curveImageData.data);
            curvesCtx.putImageData(curveImageData, 0, 0);
            
            currentTemp = 'warm';
            updateActiveButton();
            applyTemperatureChange(currentTemp);
        }

        function initiateTemperatureChange(newTemp) {
            isTransitioning = true;
            transitionCtx.clearRect(0, 0, transitionCanvas.width, transitionCanvas.height);
            transitionCtx.drawImage(processedCanvas, 0, 0);
            transitionCanvas.style.opacity = 1;
            
            applyTemperatureChange(newTemp);
            currentTemp = newTemp;
            updateActiveButton();
            
            setTimeout(() => { transitionCanvas.style.opacity = 0; }, 20);
            setTimeout(() => { isTransitioning = false; }, 400);
        }
        
        function applyTemperatureChange(temp) {
            const { width, height } = curvesCanvas;
            const baseImageData = curvesCtx.getImageData(0, 0, width, height);
            applyTemperatureShift(baseImageData.data, temp);
            processedCtx.putImageData(baseImageData, 0, 0);
            imagePreview.src = processedCanvas.toDataURL('image/png');
        }

        function updateActiveButton() {
            document.querySelectorAll('.temp-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.temp === currentTemp);
            });
        }
        
        function generateCurveLUT(x1, y1, x2, y2) {
            const lut = new Uint8ClampedArray(256);
            const points = [ [0,0], [x1,y1], [x2,y2], [255,255] ];
            for (let i = 0; i < 256; i++) {
                let p1 = points[0], p2 = points[1];
                if (i >= x1) { p1 = points[1]; p2 = points[2]; }
                if (i >= x2) { p1 = points[2]; p2 = points[3]; }
                const t = (p2[0] - p1[0]) === 0 ? 0 : (i - p1[0]) / (p2[0] - p1[0]);
                lut[i] = p1[1] + t * (p2[1] - p1[1]);
            }
            return lut;
        }
        
        function applyChannelCurves(data) {
            const redLUT = generateCurveLUT(64, 80, 192, 176);
            const greenLUT = generateCurveLUT(96, 96, 192, 210);
            const blueLUT = generateCurveLUT(64, 48, 192, 230);
            for (let i = 0; i < data.length; i += 4) {
                data[i] = redLUT[data[i]];
                data[i + 1] = greenLUT[data[i + 1]];
                data[i + 2] = blueLUT[data[i + 2]];
            }
        }

        function applyTemperatureShift(data, temp) {
            let rShift = 0, bShift = 0;
            switch (temp) {
                case 'hot':    rShift = 15; bShift = -15; break;
                case 'warm':   rShift = 8;  bShift = -8;  break;
                case 'cold':   rShift = -8; bShift = 8;   break;
                case 'frozen': rShift = -15; bShift = 15;  break;
            }
            if (rShift === 0 && bShift === 0) return;
            for (let i = 0; i < data.length; i += 4) {
                data[i] = Math.max(0, Math.min(255, data[i] + rShift));
                data[i + 2] = Math.max(0, Math.min(255, data[i + 2] + bShift));
            }
        }
    </script>
</body>
</html>

